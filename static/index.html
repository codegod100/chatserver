<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roc Chat Server</title>
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        #app {
            height: 100%;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="elm.js"></script>
    <script>
        // Initialize Elm app
        var app = Elm.Main.init({
            node: document.getElementById('app')
        });

        // WebSocket connection
        var socket = null;
        var reconnectAttempts = 0;
        var maxReconnectAttempts = 5;

        function connect() {
            var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            var wsUrl = protocol + '//' + window.location.host + '/ws';

            socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                console.log('WebSocket connected');
                reconnectAttempts = 0;
                app.ports.connectionStatus.send(true);
            };

            socket.onmessage = function(event) {
                app.ports.messageReceiver.send(event.data);
            };

            socket.onclose = function() {
                console.log('WebSocket disconnected');
                app.ports.connectionStatus.send(false);

                // Attempt to reconnect
                if (reconnectAttempts < maxReconnectAttempts) {
                    reconnectAttempts++;
                    console.log('Reconnecting... attempt ' + reconnectAttempts);
                    setTimeout(connect, 2000 * reconnectAttempts);
                }
            };

            socket.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }

        // Subscribe to messages from Elm
        app.ports.sendMessage.subscribe(function(message) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(message);
            }
        });

        // Subscribe to scroll requests from Elm
        app.ports.scrollToBottom.subscribe(function() {
            requestAnimationFrame(function() {
                var messages = document.getElementById('messages');
                if (messages) {
                    // elm-ui creates nested scrollable divs, find the one with overflow
                    var scrollable = messages.querySelector('[style*="overflow"]') || messages;
                    scrollable.scrollTop = scrollable.scrollHeight;
                }
            });
        });

        // Start connection
        connect();
    </script>
</body>
</html>
